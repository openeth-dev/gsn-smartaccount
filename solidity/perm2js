#!/usr/bin/perl

$src="./contracts/PermissionsLevel.sol";
$out = "./src/js/Permissions.js";


warn "re-creating $out from $src\n";

open SRC, $src;
open OUT, ">$out";

print OUT "//autogenerated by $0 from $src\n";
print OUT "let permissions = {\n";
while (<SRC>) {
    if ( /uint32 public/ && !$switched ) {

        print OUT "}\n\nObject.assign(permissions, {\n";
        $switched=true;
    }
    #uint32 constant public canSpend = 1 << 0;
    ($perm, $val) = /constant public (\w+)\s+=\s+(.*)\s*;\s*/;
    if ($perm ) {
        print OUT "    \u$perm: $val,\n";
        next;
    }

    #uint32 public canChangeConfig = canUnfreeze | canChangeParticipants /*| canChangeOwner*/ /* | canChan
    ( $var ) = /uint32 public (.*=.*)\s*;\s*/;
    if ( $var ) {
        $var=~s/\s=/:/;
        $var=~s/\/\*.*?\*\/\s*//g;
        $var=~s/([:|]\s+)(\w+)/$1permissions.\u$2/g;
        #$var=~s/(.{140,}|)/$1\n       /;
        print OUT "    \u$var,\n";

    }
}
print OUT "});\n\n";

print OUT "module.exports = Object.freeze(permissions);";