#!/usr/bin/perl

$src="./contracts/PermissionsLevel.sol";
$out = "./src/js/Permissions.js";

warn "re-creating $out from $src\n";

open SRC, $src;
open OUT, ">$out";

while (<SRC>) {
    if ( /uint32 public/ && !$switched ) {

        $switched=true;
    }
    #uint32 constant public canSpend = 1 << 0;

    ($perm, $val) = /constant public (\w+)\s+=\s+(.*)\s*;\s*/;
    if ($perm ) {
        push @perms, "\u$perm: $val";

        next;
    }

    #uint32 public canChangeConfig = canUnfreeze | canChangeParticipants /*| canChangeOwner*/ /* | canChan
    ( $var ) = /uint32 public (.*=.*)\s*;\s*/;
    if ( $var ) {
        $var=~s/\s=/:/;
        $var=~s/\/\*.*?\*\/\s*//g;
        $var=~s/([:|]\s+)(\w+)/$1permissions.\u$2/g;
        #$var=~s/(.{140,}|)/$1\n       /;
        ( $name, $val ) = $var=~ /(\w+)\s*[=:]\s*(.*)/;
        push @morePerms, "\u$name = $val";

    }
}
print OUT "//autogenerated by $0 from $src\n";
print OUT "let permissions = {\n";
foreach $p ( @perms) {
    print OUT "    $p,\n";
}
print OUT "}\n\n";
foreach $p ( @morePerms) {
    print OUT "permissions.$p\n";
}

print OUT "\nmodule.exports = Object.freeze(permissions);";
